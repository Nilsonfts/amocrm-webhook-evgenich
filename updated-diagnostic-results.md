# Результаты проверки учетных данных Google и рекомендации

## Диагностика проблемы с вебхуком AmoCRM в Google Sheets

### Результаты проверки учетных данных Google

✅ **Успешное подключение к Google Sheets**
- Учетные данные сервисного аккаунта `evgenich-logger@gen-lang-client-0841321145.iam.gserviceaccount.com` работают корректно
- Таблица "ЕВГ amo_CRM" (ID: `1tD89CZMI8KqaHBx0gmGsHpc9eKYvpuk3OnCOpDYMDdE`) доступна и доступ к ней установлен
- Тестовая запись была успешно добавлена в таблицу

### Выявленная проблема

Основная проблема заключалась в формате переменной окружения `GOOGLE_CREDENTIALS` на сервере Railway:

1. **Неправильный формат JSON** - переданные вами учетные данные были обрезаны или некорректно экранированы
2. **Старый файл учетных данных** - использовался устаревший private_key_id

### Решение проблемы

1. **Обновление учетных данных**:
   - Создан новый файл `google-credentials-new.json` с корректными учетными данными
   - Протестировано подключение к Google Sheets - успешно работает
   - Создан файл `.env.production` с правильно отформатированными переменными окружения

2. **Инструкции по обновлению переменных окружения на Railway**:
   - Скопируйте содержимое файла `.env.production` 
   - Импортируйте эти переменные в раздел Variables на Railway
   - Особое внимание уделите правильному формату переменной `GOOGLE_CREDENTIALS`

3. **Проверка формата данных вебхука**:
   - Создан скрипт `simulate-webhook-with-field.js` для отправки тестового вебхука с полем "Бар (deal)" = "ЕВГ СПБ"
   - Запустите его для тестирования обработки вебхука локально

### Дополнительные рекомендации

1. **Временно отключите фильтрацию**:
   - Установите `DEBUG_SKIP_FILTER="true"` на сервере для приема всех вебхуков
   - Это поможет выявить проблемы с форматом данных от AmoCRM

2. **Мониторинг логов**:
   - После обновления переменных окружения внимательно следите за логами сервера
   - Обратите внимание на ошибки, связанные с подключением к Google API или обработкой вебхуков

3. **Регулярное обновление токенов**:
   - Токены AmoCRM имеют ограниченный срок действия
   - Убедитесь, что механизм обновления токенов работает корректно

## Заключение

Проблема с интеграцией вебхуков AmoCRM с Google Sheets, скорее всего, была вызвана некорректно настроенной переменной окружения `GOOGLE_CREDENTIALS` на сервере. После обновления этой переменной с правильно отформатированными данными система должна заработать корректно.
