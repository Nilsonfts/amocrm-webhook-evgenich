# Диагностические инструменты для AmoCRM webhook-интеграции с Google Sheets

Этот набор скриптов создан для диагностики и устранения проблем в интеграции вебхуков AmoCRM с Google Sheets.

## Описание скриптов

### Основной скрипт диагностики

```bash
./run-diagnostics.sh
```

Запускает полную диагностику системы и генерирует журналы в директории `diagnostic-logs`.

### Отдельные скрипты диагностики

1. `diagnostic-scripts/environment-diagnostic.js` - проверяет переменные окружения и конфигурацию
2. `diagnostic-scripts/google-sheets-diagnostic.js` - тестирует подключение к Google Sheets API
3. `diagnostic-scripts/webhook-listener-diagnostic.js` - анализирует обработчик вебхуков
4. `diagnostic-scripts/webhook-simulator.js` - симулирует получение вебхука от AmoCRM

### Генерация отчета

```bash
node generate-report.js
```

Генерирует файл `diagnostic-results.md` с подробным отчетом на основе результатов диагностики.

## Инструкция по использованию

1. Перед запуском диагностики убедитесь, что все переменные окружения настроены
2. Запустите полную диагностику с помощью `./run-diagnostics.sh`
3. Проанализируйте результаты в файлах журналов в директории `diagnostic-logs/`
4. Создайте отчет с помощью `node generate-report.js` для удобного анализа
5. На основе отчета внесите необходимые изменения в конфигурацию и код

## Переменные окружения

Для корректной работы диагностики и самой интеграции необходимы следующие переменные окружения:

```
PORT=3000                         # Порт, на котором запущен сервер
GOOGLE_SHEET_ID=your-sheet-id     # ID таблицы Google Sheets
GOOGLE_CREDENTIALS_PATH=./path-to-credentials.json # Путь к файлу учетных данных сервисного аккаунта Google
WEBHOOK_TOKEN=your-secret-token   # Токен для вебхуков AmoCRM (если используется)
```

## Решение частых проблем

1. **Проблема с учетными данными Google Sheets**
   - Убедитесь, что файл учетных данных имеет правильный формат
   - Проверьте, что сервисный аккаунт имеет доступ к таблице
   - Убедитесь, что ID таблицы указан правильно

2. **Проблема с обработкой вебхуков**
   - Убедитесь, что сервер запущен и доступен
   - Проверьте маршрут `/webhook` для обработки POST-запросов
   - Проверьте, что код корректно обрабатывает события изменения статуса сделок

3. **Проблемы с переменными окружения**
   - Создайте файл `.env` со всеми необходимыми переменными
   - Убедитесь, что переменные загружаются при запуске приложения
