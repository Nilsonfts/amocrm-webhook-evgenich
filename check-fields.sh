#!/bin/bash

# –í–∞—à —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π (—Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ —Ç–∞–±—É–ª—è—Ü–∏–µ–π –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É)
YOUR_FIELDS="ID	–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏	–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–∞–∫—Ç	–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π	–≠—Ç–∞–ø —Å–¥–µ–ª–∫–∏	–ë—é–¥–∂–µ—Ç	–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è	–ö–µ–º —Å–æ–∑–¥–∞–Ω–∞	–¢–µ–≥–∏ —Å–¥–µ–ª–∫–∏	–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è	YM_CLIENT_ID	GA_CLIENT_ID	BUTTON_TEXT	DATE	TIME	R.–ò—Å—Ç–æ—á–Ω–∏–∫ —Å–¥–µ–ª–∫–∏	R.–¢–µ–≥ –≥–æ—Ä–æ–¥–∞	–ü–û	–ë–∞—Ä (deal)	–î–∞—Ç–∞ –±—Ä–æ–Ω–∏	–ö–æ–ª-–≤–æ –≥–æ—Å—Ç–µ–π	–í—Ä–µ–º—è –ø—Ä–∏—Ö–æ–¥–∞	–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ú–û–ë	–ò—Å—Ç–æ—á–Ω–∏–∫	–¢–∏–ø –ª–∏–¥–∞	–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ (–û–ë)	R.–°—Ç–∞—Ç—É—Å—ã –≥–æ—Å—Ç–µ–π	–°–∞—Ä–∞—Ñ–∞–Ω –≥–æ—Å—Ç–∏	UTM_MEDIUM	FORMNAME	REFERER	FORMID	–ù–æ–º–µ—Ä –ª–∏–Ω–∏–∏ MANGO OFFICE	UTM_SOURCE	UTM_TERM	UTM_CAMPAIGN	UTM_CONTENT	utm_referrer	_ym_uid	–†–∞–±–æ—á–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω (–∫–æ–Ω—Ç–∞–∫—Ç)	–ù–æ–º–µ—Ä –ª–∏–Ω–∏–∏ MANGO OFFICE (–∫–æ–Ω—Ç–∞–∫—Ç)	–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ 1"

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ–ª–µ–π AmoCRM ‚Üí Google Sheets"
echo "=================================================="

# –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞
CONFIG=$(curl -s http://localhost:3000/config/fields)

echo "üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
TOTAL_FIELDS=$(echo "$CONFIG" | jq '. | length')
echo "   –í—Å–µ–≥–æ –ø–æ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ: $TOTAL_FIELDS"

YOUR_FIELDS_COUNT=$(echo "$YOUR_FIELDS" | tr '\t' '\n' | wc -l)
echo "   –ü–æ–ª–µ–π –≤ –≤–∞—à–µ–º —Å–ø–∏—Å–∫–µ: $YOUR_FIELDS_COUNT" 

echo ""
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞:"
echo ""

MISSING_FIELDS=0
FOUND_FIELDS=0

# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤–∞—à —Å–ø–∏—Å–æ–∫ –≤ –º–∞—Å—Å–∏–≤ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ
IFS=$'\t' read -ra FIELDS_ARRAY <<< "$YOUR_FIELDS"
for field in "${FIELDS_ARRAY[@]}"; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª–µ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if echo "$CONFIG" | jq -e --arg field "$field" 'has($field)' > /dev/null; then
        echo "‚úÖ $field"
        ((FOUND_FIELDS++))
    else
        echo "‚ùå $field - –û–¢–°–£–¢–°–¢–í–£–ï–¢"
        ((MISSING_FIELDS++))
    fi
done

echo ""
echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo "   ‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ–π: $FOUND_FIELDS"
echo "   ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ–π: $MISSING_FIELDS"

if [ $MISSING_FIELDS -eq 0 ]; then
    echo ""
    echo "üéâ –û–¢–õ–ò–ß–ù–û! –í—Å–µ –ø–æ–ª—è –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Å–∏—Å—Ç–µ–º–µ!"
    echo "   –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö 42 –ø–æ–ª–µ–π –≤ Google Sheets."
else
    echo ""
    echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è. –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞."
fi
