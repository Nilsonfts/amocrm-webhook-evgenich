<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmoCRM ‚Üí Google Sheets | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }
        
        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .metric-label {
            color: #6b7280;
            font-size: 0.9em;
        }
        
        .metric-value {
            font-weight: 600;
            color: #374151;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background 0.3s ease;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #5a67d8;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: #f59e0b;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .loading {
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
        
        .actions {
            text-align: center;
            margin-top: 30px;
        }
        
        .log-container {
            background: #1f2937;
            color: #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }
        
        .log-timestamp {
            color: #9ca3af;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ AmoCRM ‚Üí Google Sheets</h1>
            <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö</p>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: #dbeafe; color: #3b82f6;">üìä</div>
                    <div class="card-title">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</div>
                </div>
                <div id="system-status">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: #dcfce7; color: #16a34a;">üìà</div>
                    <div class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                </div>
                <div id="statistics">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: #fef3c7; color: #d97706;">‚öôÔ∏è</div>
                    <div class="card-title">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</div>
                </div>
                <div id="configuration">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="card-icon" style="background: #e0e7ff; color: #6366f1;">üìù</div>
                <div class="card-title">–õ–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
            </div>
            <div class="log-container" id="activity-logs">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
            </div>
        </div>
        
        <div class="actions">
            <a href="/api/stats" class="btn" target="_blank">üìä API –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a href="/field-configurator" class="btn btn-warning">‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä –ø–æ–ª–µ–π</a>
            <button class="btn btn-success" onclick="runFullSync()">üîÑ –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
            <button class="btn" onclick="runExport()">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
        </div>
    </div>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStatus();
            loadStatistics();
            loadConfiguration();
            loadActivityLogs();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                loadSystemStatus();
                loadStatistics();
                loadActivityLogs();
            }, 30000);
        });
        
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/info');
                const data = await response.json();
                
                const statusHtml = `
                    <div class="metric">
                        <span class="metric-label">
                            <span class="status-indicator ${data.services.googleSheets ? 'status-active' : 'status-error'}"></span>
                            Google Sheets API
                        </span>
                        <span class="metric-value">${data.services.googleSheets ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—à–∏–±–∫–∞'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">
                            <span class="status-indicator ${data.services.amocrm ? 'status-active' : 'status-error'}"></span>
                            AmoCRM API
                        </span>
                        <span class="metric-value">${data.services.amocrm ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—à–∏–±–∫–∞'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</span>
                        <span class="metric-value">${data.uptime || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                    </div>
                `;
                
                document.getElementById('system-status').innerHTML = statusHtml;
            } catch (error) {
                document.getElementById('system-status').innerHTML = 
                    '<div class="metric"><span class="metric-label">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span></div>';
            }
        }
        
        async function loadStatistics() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                const statsHtml = `
                    <div class="metric">
                        <span class="metric-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤–µ–±—Ö—É–∫–æ–≤</span>
                        <span class="metric-value">${data.webhooks?.processed || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">–£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π</span>
                        <span class="metric-value">${data.syncs?.successful || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">–û—à–∏–±–æ–∫</span>
                        <span class="metric-value">${data.syncs?.errors || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span>
                        <span class="metric-value">${data.lastSync || '–ù–∏–∫–æ–≥–¥–∞'}</span>
                    </div>
                `;
                
                document.getElementById('statistics').innerHTML = statsHtml;
            } catch (error) {
                document.getElementById('statistics').innerHTML = 
                    '<div class="metric"><span class="metric-label">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span></div>';
            }
        }
        
        async function loadConfiguration() {
            try {
                const response = await fetch('/api/info');
                const data = await response.json();
                
                const configHtml = `
                    <div class="metric">
                        <span class="metric-label">–î–æ–º–µ–Ω AmoCRM</span>
                        <span class="metric-value">${data.config?.amoDomain || '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">ID —Ç–∞–±–ª–∏—Ü—ã</span>
                        <span class="metric-value">${data.config?.sheetId ? '‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω' : '‚ùå –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">–ö–æ–ª–æ–Ω–æ–∫ –¥–∞–Ω–Ω—ã—Ö</span>
                        <span class="metric-value">${data.structure?.columns || 0}</span>
                    </div>
                `;
                
                document.getElementById('configuration').innerHTML = configHtml;
            } catch (error) {
                document.getElementById('configuration').innerHTML = 
                    '<div class="metric"><span class="metric-label">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span></div>';
            }
        }
        
        function loadActivityLogs() {
            // –°–∏–º—É–ª—è—Ü–∏—è –ª–æ–≥–æ–≤ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å WebSocket –∏–ª–∏ polling)
            const logs = [
                { time: new Date().toLocaleTimeString(), message: '–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ' },
                { time: new Date(Date.now() - 60000).toLocaleTimeString(), message: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ' },
                { time: new Date(Date.now() - 120000).toLocaleTimeString(), message: 'AmoCRM API –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' },
                { time: new Date(Date.now() - 180000).toLocaleTimeString(), message: '–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (42 –∫–æ–ª–æ–Ω–∫–∏)' }
            ];
            
            const logsHtml = logs.map(log => 
                `<div class="log-entry">
                    <span class="log-timestamp">[${log.time}]</span>
                    <span>${log.message}</span>
                </div>`
            ).join('');
            
            document.getElementById('activity-logs').innerHTML = logsHtml;
        }
        
        async function runFullSync() {
            if (confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö?')) {
                try {
                    const response = await fetch('/sync/full', { method: 'POST' });
                    const result = await response.json();
                    alert(result.message || '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞');
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + error.message);
                }
            }
        }
        
        async function runExport() {
            if (confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ AmoCRM?')) {
                alert('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—â–µ–Ω –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.');
                // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å API endpoint –¥–ª—è –∑–∞–ø—É—Å–∫–∞ export.js
            }
        }
    </script>
</body>
</html>
