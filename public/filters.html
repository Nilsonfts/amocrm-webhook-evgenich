<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmoCRM –§–∏–ª—å—Ç—Ä—ã —ç–∫—Å–ø–æ—Ä—Ç–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .filter-section:hover {
            border-color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
        }

        .filter-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-options {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .filter-options::-webkit-scrollbar {
            width: 6px;
        }

        .filter-options::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .filter-options::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .checkbox-item:last-child {
            border-bottom: none;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 12px;
            transform: scale(1.2);
            accent-color: #667eea;
        }

        .checkbox-item label {
            cursor: pointer;
            color: #495057;
            font-weight: 500;
            flex: 1;
        }

        .count-badge {
            background: #667eea;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .export-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            color: white;
        }

        .export-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .selected-filters {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .selected-filters h4 {
            color: #155724;
            margin-bottom: 10px;
        }

        .filter-tag {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 3px;
            font-size: 0.9em;
        }

        .results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ AmoCRM –§–∏–ª—å—Ç—Ä—ã —ç–∫—Å–ø–æ—Ä—Ç–∞</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets</p>
        </div>

        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∂–∞—é –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ AmoCRM...
        </div>

        <div id="filters-container" style="display: none;">
            <div class="filters-grid">
                <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è -->
                <div class="filter-section">
                    <h3>üé® –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è</h3>
                    <div id="custom-fields" class="filter-options">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                    </div>
                </div>

                <!-- –í–æ—Ä–æ–Ω–∫–∏ -->
                <div class="filter-section">
                    <h3>üîÄ –í–æ—Ä–æ–Ω–∫–∏</h3>
                    <div id="pipelines" class="filter-options">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                    </div>
                </div>

                <!-- –≠—Ç–∞–ø—ã -->
                <div class="filter-section">
                    <h3>üìä –≠—Ç–∞–ø—ã —Å–¥–µ–ª–æ–∫</h3>
                    <div id="statuses" class="filter-options">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                    </div>
                </div>
            </div>

            <div id="selected-filters" class="selected-filters" style="display: none;">
                <h4>‚úÖ –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:</h4>
                <div id="filter-tags"></div>
            </div>

            <div class="export-section">
                <h3>üöÄ –ó–∞–ø—É—Å–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞</h3>
                <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏</p>
                <button id="export-btn" class="export-btn" onclick="startExport()">
                    –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
            </div>

            <div id="results" style="display: none;"></div>
        </div>
    </div>

    <script>
        let filterData = {};
        let selectedFilters = {
            customFields: {},
            pipelines: [],
            statuses: []
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                const data = await response.json();
                
                console.log('üîç –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', data);
                console.log('üîç –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è:', data.data?.customFields);
                
                if (data.success) {
                    filterData = data.data;
                    renderFilters();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('filters-container').style.display = 'block';
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('loading').innerHTML = 
                    `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`;
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function renderFilters() {
            renderCustomFields();
            renderPipelines();
            renderStatuses();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–æ–ª–µ–π
        function renderCustomFields() {
            const container = document.getElementById('custom-fields');
            container.innerHTML = '';

            console.log('üîç –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–µ–π:', filterData.customFields);
            console.log('üîç –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–µ–π:', Object.keys(filterData.customFields || {}).length);

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ–ª–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            const fieldCategories = {
                '–ë–∞—Ä (deal)': [],
                '–ê–¥—Ä–µ—Å–∞ –±–∞—Ä–æ–≤': [],
                '–î—Ä—É–≥–∏–µ –ø–æ–ª—è': []
            };

            Object.entries(filterData.customFields).forEach(([fieldName, fieldData]) => {
                console.log(`üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–ª–µ: ${fieldName}`, fieldData);
                
                if (fieldData.values.length > 0) {
                    if (fieldName.includes('–ë–∞—Ä')) {
                        fieldCategories['–ë–∞—Ä (deal)'].push([fieldName, fieldData]);
                    } else if (fieldName.includes('–ê–¥—Ä–µ—Å–∞')) {
                        fieldCategories['–ê–¥—Ä–µ—Å–∞ –±–∞—Ä–æ–≤'].push([fieldName, fieldData]);
                    } else {
                        fieldCategories['–î—Ä—É–≥–∏–µ –ø–æ–ª—è'].push([fieldName, fieldData]);
                    }
                }
            });

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            Object.entries(fieldCategories).forEach(([categoryName, fields]) => {
                if (fields.length > 0) {
                    // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = `
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        padding: 10px 15px;
                        margin: 10px 0 5px 0;
                        border-radius: 8px;
                        font-weight: bold;
                        font-size: 14px;
                        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
                    `;
                    categoryHeader.textContent = categoryName;
                    container.appendChild(categoryHeader);

                    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–ª–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                    const categoryContainer = document.createElement('div');
                    categoryContainer.style.cssText = `
                        background: #f8f9fa;
                        border: 2px solid #e9ecef;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 20px;
                    `;

                    fields.forEach(([fieldName, fieldData]) => {
                        const fieldSection = document.createElement('div');
                        fieldSection.style.marginBottom = '15px';
                        fieldSection.style.paddingBottom = '10px';
                        fieldSection.style.borderBottom = '1px solid #dee2e6';

                        const fieldTitle = document.createElement('h4');
                        fieldTitle.textContent = fieldName;
                        fieldTitle.style.cssText = `
                            color: #495057;
                            margin-bottom: 8px;
                            font-size: 13px;
                            font-weight: 600;
                        `;
                        fieldSection.appendChild(fieldTitle);

                        fieldData.values.forEach(value => {
                            const checkboxItem = document.createElement('div');
                            checkboxItem.className = 'checkbox-item';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = `${fieldName}-${value}`;
                            checkbox.onchange = () => updateCustomFieldFilter(fieldName, value, checkbox.checked);

                            const label = document.createElement('label');
                            label.htmlFor = checkbox.id;
                            label.textContent = value;
                            label.style.fontSize = '13px';

                            // –í—ã–¥–µ–ª—è–µ–º –ï–í–ì –°–ü–ë –µ—Å–ª–∏ –Ω–∞–π–¥–µ–º
                            if (value.includes('–ï–í–ì') || value.includes('–°–ü–ë')) {
                                label.style.cssText += `
                                    background: linear-gradient(135deg, #28a745, #20c997);
                                    color: white;
                                    padding: 2px 6px;
                                    border-radius: 4px;
                                    font-weight: bold;
                                `;
                            }

                            checkboxItem.appendChild(checkbox);
                            checkboxItem.appendChild(label);
                            fieldSection.appendChild(checkboxItem);
                        });

                        categoryContainer.appendChild(fieldSection);
                    });

                    container.appendChild(categoryContainer);
                }
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–æ—Ä–æ–Ω–æ–∫
        function renderPipelines() {
            const container = document.getElementById('pipelines');
            container.innerHTML = '';

            filterData.pipelines.forEach(pipeline => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `pipeline-${pipeline.id}`;
                checkbox.onchange = () => updatePipelineFilter(pipeline.id, checkbox.checked);

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.innerHTML = `${pipeline.name} <span class="count-badge">${pipeline.statuses.length}</span>`;

                checkboxItem.appendChild(checkbox);
                checkboxItem.appendChild(label);
                container.appendChild(checkboxItem);
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —ç—Ç–∞–ø–æ–≤
        function renderStatuses() {
            const container = document.getElementById('statuses');
            container.innerHTML = '';

            filterData.pipelines.forEach(pipeline => {
                pipeline.statuses.forEach(status => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'checkbox-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `status-${status.id}`;
                    checkbox.onchange = () => updateStatusFilter(status.id, checkbox.checked);

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = `${status.name} (${pipeline.name})`;

                    checkboxItem.appendChild(checkbox);
                    checkboxItem.appendChild(label);
                    container.appendChild(checkboxItem);
                });
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–æ–ª–µ–π
        function updateCustomFieldFilter(fieldName, value, checked) {
            if (!selectedFilters.customFields[fieldName]) {
                selectedFilters.customFields[fieldName] = [];
            }

            if (checked) {
                if (!selectedFilters.customFields[fieldName].includes(value)) {
                    selectedFilters.customFields[fieldName].push(value);
                }
            } else {
                selectedFilters.customFields[fieldName] = 
                    selectedFilters.customFields[fieldName].filter(v => v !== value);
                
                if (selectedFilters.customFields[fieldName].length === 0) {
                    delete selectedFilters.customFields[fieldName];
                }
            }

            updateSelectedFiltersDisplay();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –≤–æ—Ä–æ–Ω–æ–∫
        function updatePipelineFilter(pipelineId, checked) {
            if (checked) {
                if (!selectedFilters.pipelines.includes(pipelineId.toString())) {
                    selectedFilters.pipelines.push(pipelineId.toString());
                }
            } else {
                selectedFilters.pipelines = selectedFilters.pipelines.filter(id => id !== pipelineId.toString());
            }

            updateSelectedFiltersDisplay();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ —ç—Ç–∞–ø–æ–≤
        function updateStatusFilter(statusId, checked) {
            if (checked) {
                if (!selectedFilters.statuses.includes(statusId.toString())) {
                    selectedFilters.statuses.push(statusId.toString());
                }
            } else {
                selectedFilters.statuses = selectedFilters.statuses.filter(id => id !== statusId.toString());
            }

            updateSelectedFiltersDisplay();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateSelectedFiltersDisplay() {
            const container = document.getElementById('selected-filters');
            const tagsContainer = document.getElementById('filter-tags');
            
            let hasFilters = false;
            tagsContainer.innerHTML = '';

            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–æ–ª—è
            Object.entries(selectedFilters.customFields).forEach(([fieldName, values]) => {
                if (values.length > 0) {
                    values.forEach(value => {
                        const tag = document.createElement('span');
                        tag.className = 'filter-tag';
                        tag.textContent = `${fieldName}: ${value}`;
                        tagsContainer.appendChild(tag);
                        hasFilters = true;
                    });
                }
            });

            // –í–æ—Ä–æ–Ω–∫–∏
            selectedFilters.pipelines.forEach(pipelineId => {
                const pipeline = filterData.pipelines.find(p => p.id.toString() === pipelineId);
                if (pipeline) {
                    const tag = document.createElement('span');
                    tag.className = 'filter-tag';
                    tag.textContent = `–í–æ—Ä–æ–Ω–∫–∞: ${pipeline.name}`;
                    tagsContainer.appendChild(tag);
                    hasFilters = true;
                }
            });

            // –≠—Ç–∞–ø—ã
            selectedFilters.statuses.forEach(statusId => {
                let statusName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                filterData.pipelines.forEach(pipeline => {
                    const status = pipeline.statuses.find(s => s.id.toString() === statusId);
                    if (status) {
                        statusName = status.name;
                    }
                });
                
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.textContent = `–≠—Ç–∞–ø: ${statusName}`;
                tagsContainer.appendChild(tag);
                hasFilters = true;
            });

            container.style.display = hasFilters ? 'block' : 'none';
        }

        // –ó–∞–ø—É—Å–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞
        async function startExport() {
            const btn = document.getElementById('export-btn');
            const results = document.getElementById('results');
            
            btn.disabled = true;
            btn.textContent = '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é...';
            
            results.style.display = 'block';
            results.className = 'results';
            results.innerHTML = 'üöÄ –ó–∞–ø—É—Å–∫–∞—é —ç–∫—Å–ø–æ—Ä—Ç —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏...';

            try {
                const response = await fetch('/export/custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filters: selectedFilters })
                });

                const data = await response.json();
                
                if (data.status === 'started') {
                    results.className = 'results success';
                    results.innerHTML = `
                        <h4>‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!</h4>
                        <p>${data.message}</p>
                        <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ.</p>
                        <pre>${JSON.stringify(data.filters, null, 2)}</pre>
                    `;
                } else {
                    throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
            } catch (error) {
                results.className = 'results error';
                results.innerHTML = `‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`;
            }

            btn.disabled = false;
            btn.textContent = '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = loadFilterOptions;
    </script>
</body>
</html>
