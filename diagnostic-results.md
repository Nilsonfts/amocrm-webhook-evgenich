# Результаты диагностики проблемы с выгрузкой вебхука в Google Sheets

## Обнаруженные проблемы

1. **Проблема с учетными данными Google Sheets API**:
   - В файле `google-credentials.json` содержались неверные учетные данные для сервисного аккаунта
   - Правильные учетные данные находятся в переменной окружения `GOOGLE_CREDENTIALS` (сервисный аккаунт: `evgenich-logger@gen-lang-client-0841321145.iam.gserviceaccount.com`)

2. **Тестирование подключения к Google Sheets API**:
   - Успешно протестировано подключение к Google Sheets с правильными учетными данными
   - Таблица "ЕВГ amo_CRM" (ID: `1tD89CZMI8KqaHBx0gmGsHpc9eKYvpuk3OnCOpDYMDdE`) доступна для сервисного аккаунта
   - Данные из таблицы успешно загружаются

3. **Функция фильтрации сделок**:
   - Функция `isTargetDeal` в `data-synchronizer.js` работает корректно
   - Обрабатывает только сделки со значением поля "Бар (deal)" = "ЕВГ СПБ" (ID: 1039939)
   - В текущей настройке включены ВСЕ этапы сделок (нет ограничения по этапам)

## Возможные причины проблемы

1. **Учетные данные на сервере**:
   - Возможно, на сервере (Railway) не установлены правильные переменные окружения для Google API
   - Необходимо проверить наличие и корректность переменной `GOOGLE_CREDENTIALS` на сервере

2. **Формат данных вебхука**:
   - Возможно, данные, приходящие от вебхука AmoCRM, имеют другую структуру или не содержат нужных полей
   - Вебхук может не содержать поле "Бар (deal)" или его значение отличается от ожидаемого

3. **Ошибки при обработке вебхука**:
   - В журнале сервера могут быть ошибки, которые не позволяют обработать вебхук корректно
   - Необходимо проверить логи сервера на наличие ошибок ошибок

## Рекомендации по устранению

1. **Проверить переменные окружения на сервере**:
   ```
   # Проверьте наличие этих переменных на сервере Railway
   GOOGLE_CREDENTIALS='{...}'  # Должен содержать правильные учетные данные сервисного аккаунта
   GOOGLE_SHEET_ID='1tD89CZMI8KqaHBx0gmGsHpc9eKYvpuk3OnCOpDYMDdE'
   ```

2. **Включить отладочный режим**:
   ```
   # Установите эту переменную для отключения фильтрации и обработки всех сделок
   DEBUG_SKIP_FILTER=true
   ```

3. **Проверить логи сервера**:
   - Просмотрите логи сервера на Railway для выявления ошибок
   - Обратите внимание на сообщения, связанные с обработкой вебхуков и подключением к Google API

4. **Тестирование вручную**:
   - Создайте тестовую сделку в AmoCRM с полем "Бар (deal)" = "ЕВГ СПБ"
   - Проверьте, появляется ли она в Google Sheets

5. **Дополнительное логирование**:
   - Добавьте дополнительное логирование входящих вебхуков для анализа данных
   - Проверьте формат и содержимое данных, получаемых от AmoCRM

## Вывод

Система настроена правильно и должна работать с корректными данными и переменными окружения. Проблема, скорее всего, связана с неправильными переменными окружения на сервере или с форматом данных, получаемых от вебхука AmoCRM.
